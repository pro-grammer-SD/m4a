name: ðŸŽ¬ Manim Android APK Build (Production)

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'main.py'
      - 'buildozer.spec'
      - '.github/workflows/manim-android-production.yml'
      - 'src/**'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (debug/release)'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: ðŸ“‹ Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Required Files
        run: |
          echo "ðŸ” Checking for required files..."
          
          if [ ! -f "buildozer.spec" ]; then
            echo "âŒ buildozer.spec not found!"
            exit 1
          fi
          
          if [ ! -f "main.py" ]; then
            echo "âŒ main.py not found!"
            exit 1
          fi
          
          echo "âœ… buildozer.spec found"
          echo "âœ… main.py found"
          
      - name: Validate buildozer.spec
        run: |
          echo "ðŸ” Validating buildozer.spec..."
          
          # Check for required sections
          if ! grep -q "^\[app\]" buildozer.spec; then
            echo "âŒ Missing [app] section in buildozer.spec"
            exit 1
          fi
          
          if ! grep -q "^title" buildozer.spec; then
            echo "âŒ Missing title in buildozer.spec"
            exit 1
          fi
          
          if ! grep -q "^package.name" buildozer.spec; then
            echo "âŒ Missing package.name in buildozer.spec"
            exit 1
          fi
          
          if ! grep -q "^package.domain" buildozer.spec; then
            echo "âŒ Missing package.domain in buildozer.spec"
            exit 1
          fi
          
          echo "âœ… buildozer.spec is valid"
          
      - name: Check Python Syntax
        run: |
          python3 -m py_compile main.py
          echo "âœ… main.py has valid Python syntax"

  build:
    name: ðŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Set up Java JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # ============================================
      # SYSTEM DEPENDENCIES (Ubuntu 22.04 only)
      # ============================================
      - name: Install System Dependencies
        run: |
          echo "ðŸ“¦ Installing system dependencies..."
          sudo apt-get update -qq
          
          # Essential build tools
          sudo apt-get install -y \
            build-essential \
            git \
            curl \
            wget \
            pkg-config \
            autoconf \
            automake \
            libtool \
            cmake \
            ninja-build
          
          # Core graphics rendering
          sudo apt-get install -y \
            libcairo2-dev \
            libpango1.0-dev
          
          # Font and text handling
          sudo apt-get install -y \
            libfreetype6-dev \
            fonts-liberation \
            fonts-dejavu-core \
            libharfbuzz-dev \
            libfribidi-dev
          
          # Image and compression
          sudo apt-get install -y \
            libpng-dev \
            zlib1g-dev \
            libjpeg-dev
          
          # Video processing (FFmpeg)
          sudo apt-get install -y \
            ffmpeg \
            libavformat-dev \
            libavcodec-dev \
            libavdevice-dev \
            libswscale-dev \
            libswresample-dev \
            libavutil-dev \
            libavfilter-dev
          
          # SDL for Android interop
          sudo apt-get install -y \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev
          
          # GLib and introspection
          sudo apt-get install -y \
            libglib2.0-dev \
            gobject-introspection \
            libgirepository1.0-dev
          
          # XML libraries
          sudo apt-get install -y \
            libxml2-dev \
            libxslt1-dev
          
          # Security and utilities
          sudo apt-get install -y \
            libssl-dev \
            libffi-dev \
            libbz2-dev \
            xz-utils \
            unzip
          
          echo "âœ… System dependencies installed"

      - name: Install LaTeX (For Math Rendering)
        run: |
          echo "ðŸ“ Installing LaTeX dependencies..."
          sudo apt-get install -y \
            texlive \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-extra \
            texlive-fonts-recommended \
            texlive-science \
            texlive-latex-recommended \
            cm-super \
            dvipng \
            dvisvgm
          echo "âœ… LaTeX installed"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platforms;android-31
            ndk;25.2.9519653
            cmake;3.22.1
            build-tools;34.0.0

      # ============================================
      # PYTHON BUILD TOOLS
      # ============================================
      - name: Install Python Build Tools
        run: |
          echo "ðŸ Installing Python build tools..."
          python -m pip install --upgrade pip setuptools wheel
          
          pip install \
            Cython==0.29.33 \
            setuptools-scm
          
          pip install \
            buildozer \
            p4a
          
          echo "âœ… Build tools installed"

      - name: Install Manim and Dependencies
        run: |
          echo "ðŸŽ¬ Installing Manim and dependencies..."
          pip install \
            numpy \
            scipy \
            matplotlib \
            pillow \
            sympy \
            pydub \
            requests \
            watchdog \
            opencv-python \
            scikit-image \
            imageio \
            imageio-ffmpeg
          
          echo "âœ… Manim dependencies installed"

      # ============================================
      # VERIFY DEPENDENCIES
      # ============================================
      - name: Verify Critical Dependencies
        run: |
          echo "ðŸ” Verifying critical dependencies..."
          
          echo "=== System Libraries ==="
          pkg-config --modversion cairo || echo "âš ï¸ cairo not found"
          pkg-config --modversion pango || echo "âš ï¸ pango not found"
          pkg-config --modversion freetype2 || echo "âš ï¸ freetype2 not found"
          pkg-config --modversion harfbuzz || echo "âš ï¸ harfbuzz not found"
          
          echo "=== LaTeX ==="
          latex --version 2>&1 | head -3 || echo "âš ï¸ LaTeX not found"
          
          echo "=== FFmpeg ==="
          ffmpeg -version 2>&1 | head -1 || echo "âš ï¸ FFmpeg not found"
          
          echo "=== Python Packages ==="
          python -c "import numpy; print(f'âœ… numpy: {numpy.__version__}')"
          python -c "import PIL; print('âœ… pillow: OK')"
          python -c "import scipy; print('âœ… scipy: OK')"
          
          echo "âœ… Dependencies verified"

      # ============================================
      # BUILD CONFIGURATION
      # ============================================
      - name: Configure Build
        run: |
          echo "âš™ï¸ Configuring build..."
          
          # Display buildozer.spec for verification
          echo "=== buildozer.spec content ==="
          cat buildozer.spec
          echo "=============================="
          
          # Display main.py first 50 lines for verification
          echo "=== main.py (first 50 lines) ==="
          head -50 main.py
          echo "=============================="

      # ============================================
      # BUILD APK
      # ============================================
      - name: Build APK with Buildozer
        continue-on-error: true
        run: |
          echo "ðŸ—ï¸ Building APK with Buildozer..."
          
          # Set buildozer configuration
          export BUILDOZER_LOG_LEVEL=2
          
          # Accept all Android licenses
          yes | buildozer android debug 2>&1 | tee buildozer-build.log
          
          echo "Build completed (may have errors)"
        timeout-minutes: 120

      # ============================================
      # VERIFY BUILD OUTPUT
      # ============================================
      - name: Verify APK Output
        if: always()
        run: |
          echo "ðŸ” Verifying APK output..."
          
          # List entire bin directory
          if [ -d "bin" ]; then
            echo "=== Contents of bin/ ==="
            ls -lah bin/
            echo ""
          else
            echo "âš ï¸ bin directory not found"
          fi
          
          # Check for APK files
          APK_COUNT=$(find . -name "*.apk" 2>/dev/null | wc -l)
          echo "APK files found: $APK_COUNT"
          
          if [ $APK_COUNT -gt 0 ]; then
            echo "âœ… APK(s) found:"
            find . -name "*.apk" -exec ls -lh {} \;
          else
            echo "âš ï¸ No APK files generated"
          fi

      - name: Check Build Log for Errors
        if: always()
        run: |
          echo "ðŸ“‹ Checking build log..."
          
          if [ -f "buildozer-build.log" ]; then
            echo "=== Last 100 lines of build log ==="
            tail -100 buildozer-build.log
            
            echo ""
            echo "=== Searching for errors ==="
            grep -i "error" buildozer-build.log | head -20 || echo "No 'error' found in log"
          fi

      # ============================================
      # UPLOAD ALL ARTIFACTS (ALWAYS)
      # ============================================
      - name: Upload APK (if exists)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: manim-android-apk
          path: bin/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-logs
          path: buildozer-build.log
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload .buildozer Directory
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-work-dir
          path: .buildozer/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload buildozer.spec
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-config
          path: buildozer.spec
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload main.py
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-source
          path: main.py
          retention-days: 30
          if-no-files-found: ignore

      # ============================================
      # NOTIFICATIONS
      # ============================================
      - name: Build Success Summary
        if: success()
        run: |
          echo "âœ… Build completed successfully!"
          echo ""
          echo "ðŸ“± APK files:"
          ls -lh bin/*.apk 2>/dev/null || echo "No APK found"
          echo ""
          echo "ðŸ“¥ Download from Actions â†’ Artifacts tab"

      - name: Build Failure Summary
        if: failure()
        run: |
          echo "âš ï¸ Build process encountered issues!"
          echo ""
          echo "ðŸ“‹ Check these artifacts:"
          echo "  - buildozer-logs: Build output"
          echo "  - buildozer-work-dir: Build working directory"
          echo "  - build-config: Your configuration"
          echo "  - app-source: Your source code"
          echo ""
          echo "Common issues:"
          echo "  - Missing dependencies (check logs)"
          echo "  - Memory limits exceeded"
          echo "  - Network timeout during download"
          echo ""
          echo "Check buildozer-logs for detailed error messages"

  release:
    name: ðŸ“¤ Create Release & Upload All Artifacts
    runs-on: ubuntu-latest
    needs: build
    if: always()
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: manim-android-apk
          path: artifacts/apk/

      - name: Download Build Logs
        uses: actions/download-artifact@v4
        with:
          name: buildozer-logs
          path: artifacts/logs/

      - name: Download Build Config
        uses: actions/download-artifact@v4
        with:
          name: build-config
          path: artifacts/config/

      - name: Download App Source
        uses: actions/download-artifact@v4
        with:
          name: app-source
          path: artifacts/source/

      - name: Download Buildozer Work Dir
        uses: actions/download-artifact@v4
        with:
          name: buildozer-work-dir
          path: artifacts/buildozer/

      - name: Create Release Package
        run: |
          echo "ðŸ“¦ Creating comprehensive release package..."
          
          mkdir -p release-files
          
          # Copy all artifacts to release directory
          cp -r artifacts/* release-files/ 2>/dev/null || echo "Some artifacts not found (may be expected)"
          
          # Create manifest
          cat > release-files/MANIFEST.txt << 'EOF'
          ðŸŽ¬ Manim Android Build Release
          ================================
          
          Contents:
          - apk/              : APK files (if build succeeded)
          - logs/             : Buildozer build logs
          - config/           : buildozer.spec configuration
          - source/           : main.py application source
          - buildozer/        : Full buildozer work directory
          
          Build Information:
          - Build Date: $(date -u)
          - Commit: ${{ github.sha }}
          - Branch: ${{ github.ref }}
          - Workflow: ${{ github.workflow }}
          
          Instructions:
          1. Extract this archive
          2. If APK exists in apk/ folder, install: adb install -r apk/*.apk
          3. Check logs/ for build output if APK missing
          4. Review buildozer/ for detailed error information
          EOF
          
          echo "âœ… Release package created"
          ls -lah release-files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-files/apk/*.apk
            release-files/logs/*
            release-files/config/*
            release-files/source/*
            release-files/MANIFEST.txt
          draft: false
          prerelease: false
          fail_on_unmatched_files: false
          tag_name: build-${{ github.run_number }}-${{ github.run_id }}
          name: "Manim Android Build #${{ github.run_number }}"
          body: |
            ðŸŽ¬ **Manim Android APK Build Release**
            
            **Build Info:**
            - Run: #${{ github.run_number }}
            - Commit: ${{ github.sha }}
            - Branch: ${{ github.ref }}
            - Date: ${{ github.event.head_commit.timestamp }}
            
            **Artifacts Included:**
            âœ… APK files (if build succeeded)
            âœ… Complete build logs
            âœ… buildozer.spec configuration
            âœ… main.py source code
            âœ… Full buildozer working directory
            
            **Installation:**
            ```bash
            adb install -r manim-android-apk/*.apk
            ```
            
            **Build Status:**
            - Job: ${{ needs.build.result }}
            - All artifacts included regardless of status
            
            For detailed logs, extract and check the logs/ folder.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Upload Summary
        if: always()
        run: |
          echo "âœ… Release Complete!"
          echo ""
          echo "ðŸ“¦ All artifacts packaged and uploaded:"
          echo "  âœ… APK files"
          echo "  âœ… Build logs"
          echo "  âœ… Configuration"
          echo "  âœ… Source code"
          echo "  âœ… Full work directory"
          echo ""
          echo "ðŸ”— Check GitHub Releases tab for download link"
          echo "ðŸ“ Release: build-${{ github.run_number }}-${{ github.run_id }}"
          