name: üé¨ Manim Android APK Build (Production)

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'main.py'
      - 'buildozer.spec'
      - '.github/workflows/manim-android-production.yml'
      - 'src/**'
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type (debug/release)'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: üìã Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Required Files
        run: |
          echo "üîç Checking for required files..."
          
          if [ ! -f "buildozer.spec" ]; then
            echo "‚ùå buildozer.spec not found!"
            exit 1
          fi
          
          if [ ! -f "main.py" ]; then
            echo "‚ùå main.py not found!"
            exit 1
          fi
          
          echo "‚úÖ buildozer.spec found"
          echo "‚úÖ main.py found"
          
      - name: Validate buildozer.spec
        run: |
          echo "üîç Validating buildozer.spec..."
          
          # Check for required sections
          if ! grep -q "^\[app\]" buildozer.spec; then
            echo "‚ùå Missing [app] section in buildozer.spec"
            exit 1
          fi
          
          if ! grep -q "^title" buildozer.spec; then
            echo "‚ùå Missing title in buildozer.spec"
            exit 1
          fi
          
          if ! grep -q "^package.name" buildozer.spec; then
            echo "‚ùå Missing package.name in buildozer.spec"
            exit 1
          fi
          
          if ! grep -q "^package.domain" buildozer.spec; then
            echo "‚ùå Missing package.domain in buildozer.spec"
            exit 1
          fi
          
          echo "‚úÖ buildozer.spec is valid"
          
      - name: Check Python Syntax
        run: |
          python3 -m py_compile main.py
          echo "‚úÖ main.py has valid Python syntax"

  build:
    name: üèóÔ∏è Build APK
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Set up Java JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      # ============================================
      # SYSTEM DEPENDENCIES (Ubuntu 22.04 only)
      # ============================================
      - name: Install System Dependencies
        run: |
          echo "üì¶ Installing system dependencies..."
          sudo apt-get update -qq
          
          # Essential build tools
          sudo apt-get install -y \
            build-essential \
            git \
            curl \
            wget \
            pkg-config \
            autoconf \
            automake \
            libtool \
            cmake \
            ninja-build
          
          # Core graphics rendering
          sudo apt-get install -y \
            libcairo2-dev \
            libpango1.0-dev
          
          # Font and text handling
          sudo apt-get install -y \
            libfreetype6-dev \
            fonts-liberation \
            fonts-dejavu-core \
            libharfbuzz-dev \
            libfribidi-dev
          
          # Image and compression
          sudo apt-get install -y \
            libpng-dev \
            zlib1g-dev \
            libjpeg-dev
          
          # Video processing (FFmpeg)
          sudo apt-get install -y \
            ffmpeg \
            libavformat-dev \
            libavcodec-dev \
            libavdevice-dev \
            libswscale-dev \
            libswresample-dev \
            libavutil-dev \
            libavfilter-dev
          
          # SDL for Android interop
          sudo apt-get install -y \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev
          
          # GLib and introspection
          sudo apt-get install -y \
            libglib2.0-dev \
            gobject-introspection \
            libgirepository1.0-dev
          
          # XML libraries
          sudo apt-get install -y \
            libxml2-dev \
            libxslt1-dev
          
          # Security and utilities
          sudo apt-get install -y \
            libssl-dev \
            libffi-dev \
            libbz2-dev \
            xz-utils \
            unzip
          
          echo "‚úÖ System dependencies installed"

      - name: Install LaTeX (For Math Rendering)
        run: |
          echo "üìê Installing LaTeX dependencies..."
          sudo apt-get install -y \
            texlive \
            texlive-latex-base \
            texlive-latex-extra \
            texlive-fonts-extra \
            texlive-fonts-recommended \
            texlive-science \
            texlive-latex-recommended \
            cm-super \
            dvipng \
            dvisvgm
          echo "‚úÖ LaTeX installed"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platforms;android-31
            ndk;25.2.9519653
            cmake;3.22.1
            build-tools;34.0.0

      # ============================================
      # PYTHON BUILD TOOLS
      # ============================================
      - name: Install Python Build Tools
        run: |
          echo "üêç Installing Python build tools..."
          python -m pip install --upgrade pip setuptools wheel
          
          pip install \
            Cython==0.29.33 \
            setuptools-scm
          
          pip install \
            buildozer \
            p4a
          
          echo "‚úÖ Build tools installed"

      - name: Install Manim and Dependencies
        run: |
          echo "üé¨ Installing Manim and dependencies..."
          pip install \
            numpy \
            scipy \
            matplotlib \
            pillow \
            sympy \
            pydub \
            requests \
            watchdog \
            opencv-python \
            scikit-image \
            imageio \
            imageio-ffmpeg
          
          echo "‚úÖ Manim dependencies installed"

      # ============================================
      # VERIFY DEPENDENCIES
      # ============================================
      - name: Verify Critical Dependencies
        run: |
          echo "üîç Verifying critical dependencies..."
          
          echo "=== System Libraries ==="
          pkg-config --modversion cairo || echo "‚ö†Ô∏è cairo not found"
          pkg-config --modversion pango || echo "‚ö†Ô∏è pango not found"
          pkg-config --modversion freetype2 || echo "‚ö†Ô∏è freetype2 not found"
          pkg-config --modversion harfbuzz || echo "‚ö†Ô∏è harfbuzz not found"
          
          echo "=== LaTeX ==="
          latex --version 2>&1 | head -3 || echo "‚ö†Ô∏è LaTeX not found"
          
          echo "=== FFmpeg ==="
          ffmpeg -version 2>&1 | head -1 || echo "‚ö†Ô∏è FFmpeg not found"
          
          echo "=== Python Packages ==="
          python -c "import numpy; print(f'‚úÖ numpy: {numpy.__version__}')"
          python -c "import PIL; print('‚úÖ pillow: OK')"
          python -c "import scipy; print('‚úÖ scipy: OK')"
          
          echo "‚úÖ Dependencies verified"

      # ============================================
      # BUILD CONFIGURATION
      # ============================================
      - name: Configure Build
        run: |
          echo "‚öôÔ∏è Configuring build..."
          
          # Display buildozer.spec for verification
          echo "=== buildozer.spec content ==="
          cat buildozer.spec
          echo "=============================="
          
          # Display main.py first 50 lines for verification
          echo "=== main.py (first 50 lines) ==="
          head -50 main.py
          echo "=============================="

      # ============================================
      # BUILD APK
      # ============================================
      - name: Build APK with Buildozer
        run: |
          echo "üèóÔ∏è Building APK with Buildozer..."
          
          # Set buildozer configuration
          export BUILDOZER_LOG_LEVEL=2
          
          # Accept all Android licenses
          yes | buildozer android debug 2>&1 | tee buildozer-build.log
          
          BUILD_STATUS=${PIPESTATUS[1]}
          
          if [ $BUILD_STATUS -ne 0 ]; then
            echo "‚ùå Build failed with status $BUILD_STATUS"
            echo "=== Last 200 lines of build log ==="
            tail -200 buildozer-build.log
            exit 1
          fi
          
          echo "‚úÖ APK build completed"
        timeout-minutes: 120

      # ============================================
      # VERIFY BUILD OUTPUT
      # ============================================
      - name: Verify APK Output
        run: |
          echo "üîç Verifying APK output..."
          
          if [ ! -d "bin" ]; then
            echo "‚ùå bin directory not found!"
            exit 1
          fi
          
          APK_COUNT=$(find bin -name "*.apk" | wc -l)
          
          if [ $APK_COUNT -eq 0 ]; then
            echo "‚ùå No APK files found in bin/"
            ls -la bin/ || echo "bin/ directory is empty"
            exit 1
          fi
          
          echo "‚úÖ Found $APK_COUNT APK file(s)"
          
          for apk in bin/*.apk; do
            if [ -f "$apk" ]; then
              SIZE=$(du -h "$apk" | cut -f1)
              echo "üì¶ APK: $(basename $apk) | Size: $SIZE"
              
              # Verify APK integrity
              if unzip -t "$apk" > /dev/null 2>&1; then
                echo "‚úÖ APK integrity verified"
              else
                echo "‚ùå APK is corrupted!"
                exit 1
              fi
            fi
          done

      - name: Display APK Contents Summary
        if: success()
        run: |
          echo "üìä APK Contents Summary:"
          for apk in bin/*.apk; do
            if [ -f "$apk" ]; then
              echo ""
              echo "=== $(basename $apk) ==="
              echo "File count: $(unzip -l "$apk" | tail -1)"
              echo "First 20 files:"
              unzip -l "$apk" | head -22
            fi
          done

      # ============================================
      # UPLOAD ARTIFACTS
      # ============================================
      - name: Upload APK Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: manim-android-apk
          path: bin/*.apk
          retention-days: 30
          if-no-files-found: error
          compression-level: 0

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-logs
          path: |
            buildozer-build.log
            .buildozer/android/platform/build*/build/outputs/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload buildozer.spec
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-config
          path: buildozer.spec
          retention-days: 7

      # ============================================
      # NOTIFICATIONS
      # ============================================
      - name: Build Success Notification
        if: success()
        run: |
          echo "‚úÖ Build succeeded!"
          echo ""
          echo "üì± APK Details:"
          ls -lh bin/*.apk
          echo ""
          echo "üì• Download artifacts from the Actions tab"

      - name: Build Failure Notification
        if: failure()
        run: |
          echo "‚ùå Build failed!"
          echo ""
          echo "üìã Check the logs:"
          echo "  - buildozer-build.log"
          echo "  - Android SDK logs in .buildozer/"
          exit 1

  release:
    name: üì§ Create Release (Optional)
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download APK
        uses: actions/download-artifact@v4
        with:
          name: manim-android-apk
          path: apk/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          files: apk/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          